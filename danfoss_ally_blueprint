blueprint:
  name: Danfoss Ally â€“ External sensor P-boost control
  description: >
    Blueprint controls the Danfoss Ally thermostat using an external temperature sensor, allowing for dynamic temperature adjustments based on user-defined parameters.
  domain: automation
  input:
    climate_entity:
      name: Danfoss Ally thermostat
      selector:
        entity:
          domain: climate

    temp_sensor:
      name: External temperature sensor
      selector:
        entity:
          domain: sensor
          device_class: temperature

    window_sensor:
      name: Window contact (optional)
      default: ""
      selector:
        entity:
          domain: binary_sensor

    setpoint:
      name: User setpoint helper
      selector:
        entity:
          domain: input_number

    kp:
      name: Kp helper
      selector:
        entity:
          domain: input_number

    max_boost:
      name: Max boost helper
      selector:
        entity:
          domain: input_number

    activate_delta:
      name: Activate delta helper
      selector:
        entity:
          domain: input_number

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/1"

  - platform: state
    entity_id:
      - !input temp_sensor
      - !input setpoint
      - !input kp
      - !input max_boost
      - !input activate_delta
      - !input window_sensor

variables:
  user_setp: "{{ states(!input setpoint) | float(21) }}"
  temp: "{{ states(!input temp_sensor) | float(21) }}"
  kp: "{{ states(!input kp) | float(16) }}"
  max_boost_c: "{{ states(!input max_boost) | float(1.5) }}"
  activate_delta: "{{ states(!input activate_delta) | float(0.8) }}"
  window_open: >
    {% if !input window_sensor %}
      false
    {% else %}
      {{ is_state(!input window_sensor, 'on') }}
    {% endif %}
  err: "{{ user_setp - temp }}"
  raw_pct: "{{ kp * err }}"
  pct: >
    {% set p = raw_pct %}
    {% if p < 0 %} 0
    {% elif p > 100 %} 100
    {% else %} {{ p }}
    {% endif %}
  boost_c: "{{ (pct / 100 * max_boost_c) | round(2) }}"
  boosted_setp: "{{ (user_setp + boost_c) | round(1) }}"
  new_sp: |
    {% if window_open %}
      5
    {% elif err <= 0 %}
      {{ user_setp | round(1) }}
    {% else %}
      {% set wake_sp = temp + activate_delta %}
      {% set final = boosted_setp if boosted_setp > wake_sp else wake_sp %}
      {% if final < 5 %}
        5
      {% elif final > 35 %}
        35
      {% else %}
        {{ final | round(1) }}
      {% endif %}
    {% endif %}

action:
  - service: climate.set_temperature
    target:
      entity_id: !input climate_entity
    data:
      temperature: "{{ new_sp }}"
